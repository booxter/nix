name: Prepare Nix environment
description: Checkout the repo, install Nix, and configure magic Nix cache.
runs:
  using: composite
  steps:
    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v21
      with:
        extra-conf: |
          trusted-users = root runner
          allowed-users = root runner
          extra-substituters = https://cache.numtide.com https://nixos-raspberrypi.cachix.org https://cache.saumon.network/proxmox-nixos
          extra-trusted-public-keys = niks3.numtide.com-1:DTx8wZduET09hRmMtKdQDxNNthLQETkc/yaX7M4qK0g= nixos-raspberrypi.cachix.org-1:4iMO9LXa8BqhU+Rpg6LQKiGa2lsNh/j2oiYLNOQ5sPI= proxmox-nixos:D9RYSWpQQC/msZUWphOY2I5RLH5Dd6yQcaHIuug7dWM=
        determinate: false

    - name: Setup magic Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@v13
      with:
        use-flakehub: false

    - name: Report Actions cache usage
      env:
        GH_TOKEN: ${{ github.token }}
      shell: bash
      run: |
        set -euo pipefail
        gib_bytes="$((1024*1024*1024))"
        gh api -H "Accept: application/vnd.github+json" \
          "/repos/${GITHUB_REPOSITORY}/actions/cache/usage" \
          --jq "(.active_caches_size_in_bytes // 0) as \$active
            | (\$active * 100 / ${gib_bytes} | floor) as \$active_hundredths
            | \"Actions cache usage: \(\$active_hundredths / 100) GiB\""

    - name: Dump nix daemon config
      shell: bash
      run: |
        set -euo pipefail
        for conf in /etc/nix/*.conf; do
          [ -f "${conf}" ] || continue
          echo "----- ${conf} -----"
          cat "${conf}"
        done
