name: CI

on:
  pull_request:
  push:
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  format:
    name: Format check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Free disk space
        uses: ./.github/actions/free-disk-space

      - name: Prepare Nix environment
        uses: ./.github/actions/prepare-nix-env

      - name: Format
        run: nix fmt .

      - name: Ensure clean working tree
        run: |
          git status --short
          if ! git diff --quiet --exit-code; then
            echo "Repository dirty after formatting. Please commit formatting changes."
            exit 1
          fi

  build:
    needs: format
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # linux servers
          - name: frame (x86_64-linux)
            cmd: make nixos-build-target WHAT=frame
            os: ubuntu-latest
          - name: nvws (x86_64-linux)
            cmd: make nixos-build-target WHAT=nvws
            os: ubuntu-latest

          # Build just one of configs for prox nodes since other nodes are
          # identical by design.
          - name: prx1-lab (x86_64-linux)
            cmd: make nixos-build-target WHAT=prx1-lab
            os: ubuntu-latest

          # Build just one of configs for builder nodes since other nodes are
          # identical by design.
          - name: builder (x86_64-linux)
            cmd: make build-ci-vm-config WHAT=builder1
            os: ubuntu-latest
          - name: cache (x86_64-linux)
            cmd: make build-ci-vm-config WHAT=cache
            os: ubuntu-latest

          # dhcp
          - name: pi5 dhcp (aarch64-linux)
            cmd: make nixos-build-target WHAT=pi5
            os: ubuntu-24.04-arm

          # media infra
          - name: jellyfin (x86_64-linux)
            cmd: make build-ci-vm-config WHAT=jellyfin
            os: ubuntu-latest
          - name: srvarr (x86_64-linux)
            cmd: make build-ci-vm-config WHAT=srvarr
            os: ubuntu-latest

          # CI VM build scenario (full VM image)
          - name: ci vm builder1 (x86_64-linux)
            cmd: make build-ci-vm WHAT=builder1
            os: ubuntu-latest

          # home-manager
          - name: home-manager nv (x86_64-linux)
            cmd: make home-build-nv USERNAME=ihrachyshka
            os: ubuntu-latest

          # For macos, we have to build special "ci" flavors that don't use
          # custom linux-builder config that requires aarch64-linux builder.
          # Use stock builder config to pull the derivation from nixos cache
          # instead.
          - name: mair-ci (aarch64-darwin)
            cmd: make darwin-build-target WHAT=mair-ci
            os: macos-26
          - name: mmini-ci (aarch64-darwin)
            cmd: make darwin-build-target WHAT=mmini-ci
            os: macos-26
          - name: JGWXHWDL4X-ci (aarch64-darwin)
            cmd: make darwin-build-target WHAT=JGWXHWDL4X-ci
            os: macos-26

    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Free disk space
        uses: ./.github/actions/free-disk-space

      - name: Prepare Nix environment
        uses: ./.github/actions/prepare-nix-env

      - name: Build ${{ matrix.name }}
        run: ${{ matrix.cmd }}
