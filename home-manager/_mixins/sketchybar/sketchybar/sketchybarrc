PLUGIN_DIR="$CONFIG_DIR/plugins"
THEME_DIR="$CONFIG_DIR/themes"

source "$THEME_DIR/tokyonight"

bar=(
    blur_radius="$BAR_BLUR_RADIUS"
    border_color="$BAR_BORDER_COLOR"
    color="$BAR_COLOR"
    corner_radius="$BAR_CORNER_RADIUS"
    height="$BAR_HEIGHT"
    margin="$BAR_MARGIN"
    position="$BAR_POSITION"
    padding_left="$BAR_PADDING"
    padding_right="$BAR_PADDING"
    y_offset="$BAR_Y_OFFSET"
)
sketchybar --bar "${bar[@]}"

default=(
  background.color="$BACKGROUND_COLOR"
  background.border_color="$BACKGROUND_BORDER_COLOR"
  background.corner_radius="$BACKGROUND_CORNER_RADIUS"
  background.height="$BACKGROUND_HEIGHT"
  icon.drawing=on
  icon.font="$ICON_FONT"
  icon.color="$LABEL_COLOR"
  label.align="$LABEL_ALIGN"
  label.font="$LABEL_FONT"
  label.color="$LABEL_COLOR"
  label.highlight_color="$LABEL_HIGHLIGHT_COLOR"
  label.y_offset="$LABEL_Y_OFFSET"
  label.padding_left="$LABEL_PADDING"
  label.padding_right="$LABEL_PADDING"
  y_offset="$Y_OFFSET"
)
sketchybar --default "${default[@]}"

sketchybar --add event aerospace_workspace_change
for sid in $(aerospace list-workspaces --all); do
    sketchybar --add item space.$sid left \
        --subscribe space.$sid aerospace_workspace_change \
        --set space.$sid \
        background.color=0x44ffffff \
        background.corner_radius=5 \
        background.height=25 \
        background.drawing=off \
        label="$sid" \
        click_script="aerospace workspace $sid" \
        script="$CONFIG_DIR/plugins/aerospace.sh $sid"
done

sketchybar --add item chevron left \
           --set chevron icon=􀁖  label.drawing=off \
           --add item front_app left \
           --set front_app icon.drawing=off script="$PLUGIN_DIR/front_app.sh" \
           --subscribe front_app front_app_switched

sketchybar --add item clock right \
           --set clock update_freq=10 icon=􀐫  script="$PLUGIN_DIR/clock.sh" \
           --add item volume right \
           --set volume script="$PLUGIN_DIR/volume.sh" \
           --subscribe volume volume_change \
           --add item battery right \
           --set battery update_freq=120  script="$PLUGIN_DIR/battery.sh" \
           --subscribe battery system_woke power_source_change

# Source: https://github.com/nicolas-martin/awesome-sketchybar/blob/b710fe2fe03c2725efa5ae4cd8c6503a3ffc15be/plugins/Combined-Wifi-Status-IP-Address-and-VPN-.md
BLACK=0xff1a1b26
BACKGROUND=$BLACK
YELLOW=0xffd19a66
GREEN=0xffa6e3a1
BLUE=0xff7aa2f7
sketchybar --add item  ip_address right                              \
           --set       ip_address script="$PLUGIN_DIR/ip_address.sh" \
                                  update_freq=30                     \
                                  padding_left=2                     \
                                  padding_right=8                    \
                                  background.border_width=0          \
                                  background.corner_radius=6         \
                                  background.height=24               \
           --subscribe ip_address wifi_change                        \
                                                                     \
           --add item  network.up right                              \
           --set       network.up script="$PLUGIN_DIR/network.sh"    \
                                  update_freq=20                     \
                                  padding_left=2                     \
                                  padding_right=2                    \
                                  background.border_width=0          \
                                  background.height=24               \
                                  icon=⇡                             \
                                  icon.color=$YELLOW                 \
                                  label.color=$YELLOW                \
                                                                     \
           --add item  network.down right                            \
           --set       network.down script="$PLUGIN_DIR/network.sh"  \
                               update_freq=20                        \
                               padding_left=8                        \
                               padding_right=2                       \
                               background.border_width=0             \
                               background.height=24                  \
                               icon=⇣                                \
                               icon.color=$GREEN                     \
                               label.color=$GREEN

# Bracket
sketchybar --add bracket status ip_address network.up network.down   \
           --set         status background.color=$BACKGROUND         \
                                background.border_color=$BLUE

sketchybar --add item  stock right                              \
           --set       stock script="$PLUGIN_DIR/stock.sh" \
                                  update_freq=300                    \

# Original source: https://github.com/nicolas-martin/awesome-sketchybar/blob/master/plugins/Spotify-Player-Controls.md
SPOTIFY_EVENT="com.spotify.client.PlaybackStateChanged"
POPUP_SCRIPT="sketchybar -m --set \$NAME popup.drawing=toggle"

sketchybar --add       event           spotify_change $SPOTIFY_EVENT      \
           --add       item            spotify.name left                \
           --set       spotify.name    click_script="$POPUP_SCRIPT"       \
                                       popup.horizontal=on                \
                                       popup.align=center                 \
                                       icon.drawing=off                   \
                                                                          \
           --add       item            spotify.back popup.spotify.name    \
           --set       spotify.back    icon=􀊎                             \
                                       icon.padding_left=5                \
                                       icon.padding_right=5               \
                                       script="$PLUGIN_DIR/spotify.sh"    \
                                       label.drawing=off                  \
           --subscribe spotify.back    mouse.clicked                      \
                                                                          \
           --add       item            spotify.play popup.spotify.name    \
           --set       spotify.play    icon=􀊔                             \
                                       icon.padding_left=5                \
                                       icon.padding_right=5               \
                                       updates=on                         \
                                       label.drawing=off                  \
                                       script="$PLUGIN_DIR/spotify.sh"    \
           --subscribe spotify.play    mouse.clicked spotify_change       \
                                                                          \
           --add       item            spotify.next popup.spotify.name    \
           --set       spotify.next    icon=􀊐                             \
                                       icon.padding_left=5                \
                                       icon.padding_right=10              \
                                       label.drawing=off                  \
                                       script="$PLUGIN_DIR/spotify.sh"    \
           --subscribe spotify.next    mouse.clicked                      \
                                                                          \
           --add       item            spotify.shuffle popup.spotify.name \
           --set       spotify.shuffle icon=􀊝                             \
                                       icon.highlight_color=0xff1DB954    \
                                       icon.padding_left=5                \
                                       icon.padding_right=5               \
                                       label.drawing=off                  \
                                       script="$PLUGIN_DIR/spotify.sh"    \
           --subscribe spotify.shuffle mouse.clicked                      \
                                                                          \
           --add       item            spotify.repeat popup.spotify.name  \
           --set       spotify.repeat  icon=􀊞                             \
                                       icon.highlight_color=0xff1DB954    \
                                       icon.padding_left=5                \
                                       icon.padding_right=5               \
                                       label.drawing=off                  \
                                       script="$PLUGIN_DIR/spotify.sh"    \
           --subscribe spotify.repeat  mouse.clicked

# Automatically apply configuration changes
sketchybar --hotload on

# Force all scripts to run the first time (never do this in a script)
sketchybar --update
